name: Release Desktop (Windows)

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (for manual reruns, e.g. v0.0.4)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: windows-latest
    env:
      RELEASE_TAG: ${{ github.event_name == 'release' && github.event.release.tag_name || inputs.tag }}
      CSC_LINK: ${{ secrets.WIN_CSC_LINK }}
      CSC_KEY_PASSWORD: ${{ secrets.WIN_CSC_KEY_PASSWORD }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Validate inputs and signing secrets
        shell: bash
        run: |
          if [ -z "${RELEASE_TAG}" ]; then
            echo "RELEASE_TAG is required."
            exit 1
          fi

          if [ -z "${CSC_LINK}" ] || [ -z "${CSC_KEY_PASSWORD}" ]; then
            echo "Windows signing secrets are missing."
            echo "Set WIN_CSC_LINK and WIN_CSC_KEY_PASSWORD in repository secrets."
            exit 1
          fi

      - name: Checkout repository at release tag
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_TAG }}

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.5

      - name: Install dependencies
        run: bun install

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: apps/desktop/sidecar -> target

      - name: Build client renderer
        working-directory: apps/client
        run: bun run build

      - name: Build desktop renderer and main process
        working-directory: apps/desktop
        run: |
          bun run build:sidecar
          bun run build:main
          bun run prepare:renderer

      - name: Package signed Windows installer and updater metadata
        working-directory: apps/desktop
        run: bunx electron-builder --win nsis --x64 --publish never

      - name: Validate updater metadata
        working-directory: apps/desktop
        shell: bash
        run: |
          set -euo pipefail

          metadata_file="$(ls build/out/latest*.yml 2>/dev/null | head -n1 || true)"
          if [ -z "${metadata_file}" ]; then
            echo "No latest*.yml updater metadata found in apps/desktop/build/out"
            ls -la build/out || true
            exit 1
          fi

          installer_path="$(sed -n 's/^path:[[:space:]]*//p' "${metadata_file}" | tr -d '\r' | head -n1)"
          installer_path="${installer_path#\"}"
          installer_path="${installer_path%\"}"

          if [ -z "${installer_path}" ]; then
            echo "Could not parse installer path from ${metadata_file}"
            sed -n '1,120p' "${metadata_file}" || true
            exit 1
          fi

          if [ ! -f "build/out/${installer_path}" ]; then
            echo "Updater metadata points to missing installer: build/out/${installer_path}"
            ls -la build/out || true
            sed -n '1,120p' "${metadata_file}" || true
            exit 1
          fi

          echo "Validated updater metadata installer path: ${installer_path}"

      - name: Upload desktop assets to GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: |
            apps/desktop/build/out/*.exe
            apps/desktop/build/out/*.blockmap
            apps/desktop/build/out/latest*.yml
